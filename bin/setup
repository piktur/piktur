#!/usr/bin/env ruby

# frozen_string_literal: true

require 'pathname'

ENV['RAILS_ENV'] ||= 'development'

APP_ROOT  = Pathname.new File.expand_path('..', __dir__)
DEV_ROOT  = APP_ROOT.parent
BITBUCKET = 'https://${BUNDLE_BITBUCKET__ORG}@bitbucket.com/piktur'
SERVICES  = %w(
  piktur
  piktur_admin
  piktur_assets
  piktur_api
  piktur_blog
  piktur_sites
  piktur_core
  piktur_docs
  piktur_security
  piktur_sites
  piktur_spec
  piktur_stores
).freeze

def clone(repo)
  system "git clone #{BITBUCKET}/#{repo}.git"
end

def update(branch = nil)
  system 'git pull --all'
  system "git checkout #{branch}" if branch
end

def bundler_local(repo)
  system "bin/bundle config --local local.#{repo} #{PIKTUR_HOME}/#{repo}"
end

def bundle
  system 'bin/bundle check || bin/bundle install'
end

Dir.chdir DEV_ROOT do
  puts '# Export environment variables'

  # @todo Decrypt and export secrets
  # load File.expand_path('../env', __FILE__)
  # system 'export $(cat .env.common)'

  SERVICES.each do |repo|
    clone(repo)
    bundler_local(repo)
  end

  SERVICES.each do |repo|
    Dir.chdir DEV_ROOT.join(repo) do
      update(repo) # rubocop:disable SaveBang
      bundler_local(repo)
      bundle
    end
  end

  bundle
end
