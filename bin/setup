#!/usr/bin/env ruby

# frozen_string_literal: true

# |-- /gem_server        # Private gem server
# |-- /gems              # Store forked gems
# |-- <project_name>     # Store common config and untracked files ie. `.env`
#   |-- /piktur          # Piktur
#   |-- /piktur_admin    # Piktur::Admin
#   |-- /piktur_api      # Piktur::Api
#   |-- /piktur_blog     #
#   |-- /piktur_client   # Piktur::Client
#   |-- /piktur_core     # Piktur::Core
#   |-- /piktur_docs     # Piktur::Docs
#   |-- /piktur_security # Piktur::Security
#
# @todo We may also want to clone forked gems
#   * yard
#   * amoeba
#   * annotate_models
#   * awesome_print
#
# @todo [Host secrets privately or store encrypted files on git, then decrypt on clone.](https://trello.com/c/iymYXp4X/203-env)

require 'pathname'

ENV['RAILS_ENV'] ||= 'development'

APP_ROOT  = Pathname.new File.expand_path('../', __dir__)
DEV_ROOT  = APP_ROOT.parent # Pathname.pwd.join('piktur')
BITBUCKET = 'https://${BUNDLE_BITBUCKET__ORG}@bitbucket.com/piktur'
SERVICES  = %w(
  piktur
  piktur_admin
  piktur_api
  piktur_blog
  piktur_client
  piktur_core
  piktur_docs
  piktur_security
  piktur_store
).freeze

def clone(repo, branch = 'maste')
  system "git clone #{BITBUCKET}/#{repo}.git -b #{branch}"
end

def bundler_local(repo)
  system "bundle config --local local.#{repo} #{PIKTUR_ROOT}/#{repo}"
end

def bundle
  system 'bundle check || bundle install'
end

Dir.chdir DEV_ROOT do
  puts '# Export environment variables'

  # @todo Decrypt and export secrets
  # load File.expand_path('../env', __FILE__)
  # system 'export $(cat .env.common)'

  SERVICES.each do |repo|
    clone(repo)
    bundler_local(repo)
  end

  SERVICES.each do |repo|
    Dir.chdir DEV_ROOT.join(repo) do
      bundler_local(repo)
      bundle
    end
  end

  bundle
end
